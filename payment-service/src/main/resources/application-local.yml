app:
  instance-id: ${POD_NAME:${HOSTNAME:${random.value}}}
  cache:
    ttl-seconds: 3600
  payment-service:
    api-key: secretpaymentapikey12345
  account-balance:
    delta-ttl-seconds: 300  # 5 minutes - Redis delta TTL
    idempotency-ttl-seconds: 86400  # 24 hours - Redis idempotency key TTL
    snapshot-interval: PT1M  # 1 minute - Snapshot job frequency

  # TopicAdminConfig reads these
  kafka:
    specs:
      payment_order_created_topic:                { partitions: 48, replicas: 1, createDlq: true }
      payment_order_capture_request_queue_topic:  { partitions: 48, replicas: 1, createDlq: true }
      payment_order_succeeded_topic:              { partitions: 48, replicas: 1, createDlq: true }
      payment_order_psp_result_updated_topic:     { partitions: 48, replicas: 1, createDlq: true }
      payment_order_finalized_topic:              { partitions: 48, replicas: 1, createDlq: true }
      #ledger related topic
      payment_authorized_topic:                   {partitions: 12, replicas: 1, createDlq: true}
      ledger_record_request_queue_topic:          { partitions: 24, replicas: 1, createDlq: true }
      ledger_entries_recorded_topic:              { partitions: 24, replicas: 1, createDlq: true }
  # manual datasource configs for web ourboxdispatcher and parttionen maintencance job
  datasource:
    web:
      jdbc-url: ${SPRING_DATASOURCE_URL}
      username: ${SPRING_DATASOURCE_USERNAME}
      password: ${SPRING_DATASOURCE_PASSWORD}
      driver-class-name: org.postgresql.Driver
      pool-name: web-pool
      maximum-pool-size: 12
      minimum-idle: 6
      connection-timeout: 1000
      validation-timeout: 1000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

    outbox:
      jdbc-url: ${SPRING_DATASOURCE_URL}
      username: ${SPRING_DATASOURCE_USERNAME}
      password: ${SPRING_DATASOURCE_PASSWORD}
      driver-class-name: org.postgresql.Driver
      pool-name: outbox-pool
      maximum-pool-size: 6
      minimum-idle: 3
      connection-timeout: 1500
      validation-timeout: 1500
      idle-timeout: 600000
      max-lifetime: 1800000

    maintenance:
      jdbc-url: ${SPRING_DATASOURCE_URL}
      username: ${SPRING_DATASOURCE_USERNAME}
      password: ${SPRING_DATASOURCE_PASSWORD}
      driver-class-name: org.postgresql.Driver
      pool-name: maint-pool
      maximum-pool-size: 1
      minimum-idle: 0
      connection-timeout: 1500
      validation-timeout: 1500
      idle-timeout: 60000
      max-lifetime: 1800000


server:
  port: 8080
  tomcat:
    mbeanregistry:
      enabled: true
    threads:
      max: 16
    accept-count: 64


spring:
  application:
    name: payment-service
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI}

  kafka:
    # client defaults used by your custom ProducerFactory too
    properties:
      security.protocol: PLAINTEXT
      session.timeout.ms: 45000

#  datasource:
#    url: ${SPRING_DATASOURCE_URL}
#    username: ${SPRING_DATASOURCE_USERNAME}
#    password: ${SPRING_DATASOURCE_PASSWORD}
#    hikari:
#      maximum-pool-size: 5          # keep what we agreed
#      minimum-idle: 5
#      connection-timeout: 1000      # < TimeLimiter; turns “hidden queueing” into a clear 503-worthy error
#      validation-timeout: 1000
#      leak-detection-threshold: 60000


  data:
    redis:
      url: ${SPRING_DATA_REDIS_URL}
      timeout: 10s               # Increased from 2s to handle snapshot job and retry operations under load
      lettuce:
        pool:
          max-active: 16         # Increased to handle concurrent operations
          max-idle: 8
          min-idle: 4            # Pre-warm connections for better performance
          max-wait: 5000ms       # Wait up to 5s for connection from pool
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/changelog.master.xml

spring.jackson.time-zone: UTC

mybatis:
  mapper-locations: classpath:mapper/*.xml

management:
  server:
    port: 9000
  health:
    probes:
      enabled: true
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: "prometheus,metrics,health"
  endpoint:
    health:
      enabled: true
      show-details: always
    prometheus.enabled: true
  metrics:
    tags:
      application: payment-service
    enable:
      all: false
      tomcat.threads.current: true      # current thread count
      tomcat.threads.busy: true         # threads handling requests
      tomcat.threads.config.max: true
      http.server.requests: true
      tomcat.threads: true
      hikaricp.connections: true
      hikaricp.connections.acquire: true
      kafka.producer.topic.record.send: true
      process.cpu.usage: true
      jvm.threads.live: true
      jvm.memory.used: true
      jvm.memory.max: true
      jvm.gc.pause: true
      # YOUR custom meters (exact names with underscores)
      outbox_dispatched_total: true
      outbox_dispatch_failed_total: true
      outbox_event_backlog: true
      outbox_dispatcher_duration: true
    binders:
      tomcat:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
        outbox_dispatcher_duration: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
        outbox_dispatcher_duration: 0.5,0.95,0.99
    export.prometheus.enabled: true

outbox-dispatcher:
  thread-count: 2
  batch-size: 300
  pool-size: 2

db:
  web:
    statement-timeout-ms: 500
    lock-timeout-ms: 250
    idle-in-tx-timeout-ms: 0
  outbox:
      statement-timeout-ms: 2000
      lock-timeout-ms: 200
      idle-in-tx-timeout-ms: 0

stripe: # on live  inject this as a seret to the environment ,or store in a vault
  api:
    api-key: sk_test_51ShA8HEAJKUKtoJwTALvrfMadP0eoKwyggnasHkqgY6y6jLoSjg9YqewkxiYrRw54TnZ7tVFX5Xreg3qaHm5wWAX00tupdpr6y
    connect-timeout: 5000  # 10 seconds in milliseconds (was 5ms - too short!)
    read-timeout: 30000     # 30 seconds in milliseconds (was 20ms - too short!)

psp:
  authorization:
    simulation:
      currentScenario: NORMAL
      scenarios:
        NORMAL:
          timeouts:
            enabled: true
            probability: 0       # 2% of total requests time out
          latency:
            fast:
              probability: 100    # rest of 100% are fast (50–150ms)
              minMs: 50
              maxMs: 150
            moderate:
              probability: 20    # 0% are moderate (150–300ms)
              minMs: 150
              maxMs: 300
            slow:
              probability: 0     # 0% are slow (300–600ms)
              minMs: 300
              maxMs: 600
          response:
            successful: 100
            retryable: 0
            statusCheck: 0
            nonRetryable: 0
payments:
  id:
    epoch-millis: 1735689600000   # 2025-01-01T00:00:00Z
    region-id: 1                  # EU1
    num-coord-shards: 8
    num-seller-shards: 32