<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">
        <!-- =============================================================
             01. Create main partitioned outbox_event table
             ============================================================= -->
        <changeSet id="20251112-01-create-outbox-event-parent" author="dogancaglar">
            <sql>
                CREATE TABLE outbox_event (
                oeid           BIGINT NOT NULL,
                event_type     VARCHAR(255) NOT NULL,
                aggregate_id   VARCHAR(255) NOT NULL,
                payload        TEXT NOT NULL,
                status         VARCHAR(50) NOT NULL,
                created_at     TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC'),
                updated_at     TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC'),
                claimed_at     TIMESTAMP WITHOUT TIME ZONE,
                claimed_by     VARCHAR(128),
                PRIMARY KEY (oeid, created_at)
                )
                PARTITION BY RANGE (created_at);
            </sql>
        </changeSet>

        <!-- =============================================================
             02. Helpful indexes for filtering, ordering, claiming
             ============================================================= -->
        <changeSet id="20251112-02-create-index-outbox-event-createdat" author="dogancaglar">
            <createIndex indexName="idx_outbox_event_createdat" tableName="outbox_event">
                <column name="created_at"/>
            </createIndex>
        </changeSet>

        <changeSet id="20251112-03-create-index-outbox-event-status" author="dogancaglar">
            <createIndex indexName="idx_outbox_event_status" tableName="outbox_event">
                <column name="status"/>
            </createIndex>
        </changeSet>

        <changeSet id="20251112-04-create-index-outbox-status-createdat" author="dogancaglar">
            <createIndex indexName="idx_outbox_status_createdat" tableName="outbox_event">
                <column name="status"/>
                <column name="created_at"/>
            </createIndex>
        </changeSet>

        <changeSet id="20251112-05-create-index-outbox-status-claimedat" author="dogancaglar">
            <createIndex indexName="idx_outbox_status_claimed_at" tableName="outbox_event">
                <column name="status"/>
                <column name="claimed_at"/>
            </createIndex>
        </changeSet>

    </databaseChangeLog>