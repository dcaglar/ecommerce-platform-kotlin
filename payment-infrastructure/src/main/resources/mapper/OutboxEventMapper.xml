<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dogancaglar.paymentservice.adapter.outbound.persistence.mybatis.OutboxEventMapper">

    <!-- ============================================================
         RESULT MAP: Must include all columns returned by queries
         ============================================================ -->
    <resultMap id="OutboxEventResultMap"
               type="com.dogancaglar.paymentservice.adapter.outbound.persistence.entity.OutboxEventEntity">
        <id property="oeid" column="oeid"/>
        <result property="eventType" column="event_type"/>
        <result property="aggregateId" column="aggregate_id"/>
        <result property="payload" column="payload"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"
                typeHandler="com.dogancaglar.paymentservice.adapter.outbound.persistence.mybatis.typehandler.InstantTypeHandler"/>
        <result property="updatedAt" column="updated_at"
                typeHandler="com.dogancaglar.paymentservice.adapter.outbound.persistence.mybatis.typehandler.InstantTypeHandler"/>
        <result property="claimedAt" column="claimed_at"
                typeHandler="com.dogancaglar.paymentservice.adapter.outbound.persistence.mybatis.typehandler.InstantTypeHandler"/>
        <result property="claimedBy" column="claimed_by"/>
    </resultMap>

    <!-- ============================================================
         QUERIES
         ============================================================ -->

    <select id="findByStatus" resultMap="OutboxEventResultMap">
        SELECT oeid,
        event_type,
        aggregate_id,
        payload,
        status,
        created_at,
        updated_at,
        claimed_at,
        claimed_by
        FROM outbox_event
        WHERE status = #{status}
    </select>

    <select id="countByStatus" resultType="long">
        SELECT COUNT(*) FROM outbox_event WHERE status = #{status}
    </select>

    <!-- ============================================================
         BATCH CLAIM QUERY
         ============================================================ -->
    <select id="findBatchForDispatch" resultMap="OutboxEventResultMap">
        WITH claimed AS (
        UPDATE outbox_event
        SET status = 'PROCESSING',
        claimed_at = (now() AT TIME ZONE 'UTC'),
        claimed_by = #{workerId}
        WHERE (oeid, created_at) IN (
        SELECT oeid, created_at
        FROM outbox_event
        WHERE status = 'NEW'
        ORDER BY created_at
        LIMIT #{batchSize}
        FOR UPDATE SKIP LOCKED
        )
        RETURNING oeid,
        event_type,
        aggregate_id,
        payload,
        status,
        created_at,
        updated_at,
        claimed_at,
        claimed_by
        )
        SELECT oeid,
        event_type,
        aggregate_id,
        payload,
        status,
        created_at,
        updated_at,
        claimed_at,
        claimed_by
        FROM claimed
    </select>

    <!-- ============================================================
         INSERTS
         ============================================================ -->
    <insert id="insertOutboxEvent"
            parameterType="com.dogancaglar.paymentservice.adapter.outbound.persistence.entity.OutboxEventEntity">
        INSERT INTO outbox_event (
        oeid, event_type, aggregate_id, payload, status,
        created_at, updated_at, claimed_at, claimed_by
        )
        VALUES (
        #{oeid}, #{eventType}, #{aggregateId}, #{payload}, #{status},
        #{createdAt}, #{updatedAt}, #{claimedAt}, #{claimedBy}
        )
    </insert>

    <insert id="insertAllOutboxEvents" parameterType="java.util.List">
        INSERT INTO outbox_event (
        oeid, event_type, aggregate_id, payload, status,
        created_at, updated_at, claimed_at, claimed_by
        )
        VALUES
        <foreach collection="list" item="event" separator=",">
            (#{event.oeid},
            #{event.eventType},
            #{event.aggregateId},
            #{event.payload},
            #{event.status},
            #{event.createdAt},
            #{event.updatedAt},
            #{event.claimedAt},
            #{event.claimedBy})
        </foreach>
    </insert>

    <!-- ============================================================
         UPDATES
         ============================================================ -->
    <update id="updateOutboxEventStatus">
        UPDATE outbox_event
        SET status = #{status},
        updated_at = (now() AT TIME ZONE 'UTC')
        WHERE oeid = #{oeid}
    </update>

    <update id="unclaimSpecific" parameterType="map">
        UPDATE outbox_event
        SET status = 'NEW',
        claimed_at = NULL,
        claimed_by = NULL
        WHERE status = 'PROCESSING'
        AND claimed_by = #{workerId}
        AND oeid IN
        <foreach collection="oeids" item="id" open="(" separator="," close=")">
            #{id,jdbcType=BIGINT}
        </foreach>
    </update>

    <update id="reclaimStuckClaims" parameterType="int">
        UPDATE outbox_event
        SET status = 'NEW',
        claimed_at = NULL,
        claimed_by = NULL
        WHERE status = 'PROCESSING'
        AND claimed_at &lt; ((now() AT TIME ZONE 'UTC') - (#{olderThanSeconds} || ' seconds')::interval)
    </update>

    <update id="batchUpdate" parameterType="java.util.List">
        WITH rows(oeid, created_at, status) AS (
        VALUES
        <foreach collection="list" item="e" separator=",">
            (#{e.oeid}, #{e.createdAt}::timestamp, #{e.status})
        </foreach>
        )
        UPDATE outbox_event o
        SET status = rows.status,
        claimed_at = NULL,
        claimed_by = NULL,
        updated_at = (now() AT TIME ZONE 'UTC')
        FROM rows
        WHERE o.oeid = rows.oeid
        AND o.created_at = rows.created_at
    </update>
</mapper>
