{
  "title": "Payment Service Deep Dive (30s Scrape)-Merged",
  "uid": "payment-svc-merged",
  "timezone": "browser",
  "schemaVersion": 41,
  "version": 1,
  "refresh": "30s",
  "templating": {
    "list": []
  },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "type": "dashboard",
        "name": "Annotations & Alerts",
        "enabled": true
      }
    ]
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "panels": [
    {
      "title": "HTTP Requests Per Second (/payments)",
      "type": "timeseries",
      "id": 1,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{uri=\"/payments\"}[2m])) by (method)",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 0,
        "y": 0
      }
    },
    {
      "title": "HTTP Latency Percentiles (p50/p95/p99)",
      "type": "timeseries",
      "id": 2,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{uri=\"/payments\"}[2m])) by (le))",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{uri=\"/payments\"}[2m])) by (le))",
          "legendFormat": "p95",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{uri=\"/payments\"}[2m])) by (le))",
          "legendFormat": "p99",
          "refId": "C"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 12,
        "y": 0
      }
    },
    {
      "title": "Kafka Consumer Lag by Topic",
      "type": "timeseries",
      "id": 3,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "max(kafka_consumer_fetch_manager_records_lag) by (topic)",
          "legendFormat": "{{topic}}",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 0,
        "y": 7
      }
    },
    {
      "title": "Kafka Consumer Fetch Latency (ms)",
      "type": "timeseries",
      "id": 4,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "avg(kafka_consumer_fetch_manager_fetch_latency_avg) by (topic)",
          "legendFormat": "{{topic}}",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 12,
        "y": 7
      }
    },
    {
      "title": "Kafka Producer Sent Messages (by Topic)",
      "type": "timeseries",
      "id": 5,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(rate(kafka_producer_topic_record_send_total[2m])) by (topic)",
          "legendFormat": "{{topic}}",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 0,
        "y": 14
      }
    },
    {
      "title": "Kafka Records Consumed (by Topic)",
      "type": "timeseries",
      "id": 6,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(rate(kafka_consumer_fetch_manager_records_consumed_total[2m])) by (topic)",
          "legendFormat": "{{topic}}",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 7,
        "w": 12,
        "x": 12,
        "y": 14
      }
    },
    {
      "title": "Kafka Consumer IO Time (ms)",
      "type": "timeseries",
      "id": 7,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "(rate(kafka_consumer_io_time_ns_total[2m])/1e6)",
          "legendFormat": "IO Time (ms)",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 6,
        "w": 12,
        "x": 0,
        "y": 21
      }
    },
    {
      "title": "Scheduled Task Active Threads",
      "type": "gauge",
      "id": 20,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "scheduler_active_threads{name=\"scheduled-task\"}",
          "legendFormat": "Active Threads",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 0,
        "y": 41
      }
    },
    {
      "title": "Scheduled Task Pool Size",
      "type": "gauge",
      "id": 21,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "scheduler_pool_size_threads{name=\"scheduled-task\"}",
          "legendFormat": "Pool Size",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 6,
        "y": 41
      }
    },
    {
      "title": "Scheduled Task Queue Size",
      "type": "gauge",
      "id": 22,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "scheduler_scheduled_task_count{name=\"scheduled-task\"}",
          "legendFormat": "Tasks in Queue",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 12,
        "y": 41
      }
    },
    {
      "title": "Thread Pool Utilization (%)",
      "type": "gauge",
      "id": 8,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent"
        }
      },
      "targets": [
        {
          "expr": "executor_active / executor_pool_max * 100",
          "legendFormat": "Thread Pool Utilization",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 12,
        "y": 21
      }
    },
    {
      "title": "DB Connection Pool Utilization (%)",
      "type": "gauge",
      "id": 9,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent"
        }
      },
      "targets": [
        {
          "expr": "(hikaricp_connections_active/hikaricp_connections_max)*100",
          "legendFormat": "DB Pool Utilization",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 18,
        "y": 21
      }
    },
    {
      "title": "DB Pool Pending Connections",
      "type": "gauge",
      "id": 10,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "hikaricp_connections_pending",
          "legendFormat": "Pending Connections",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 0,
        "y": 26
      }
    },
    {
      "title": "DB Acquire Time (max seconds)",
      "type": "gauge",
      "id": 11,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "s"
        }
      },
      "targets": [
        {
          "expr": "hikaricp_connections_acquire_seconds_max",
          "legendFormat": "Acquire Time (max)",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 6,
        "y": 26
      }
    },
    {
      "title": "Redis Retry Batch Size",
      "type": "gauge",
      "id": 24,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "redis_retry_batch_size",
          "legendFormat": "Redis Retry Batch",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 0,
        "y": 46
      }
    },
    {
      "title": "Redis Retry Events Processed/Failed",
      "type": "timeseries",
      "id": 25,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "rate(redis_retry_events_processed_total[2m])",
          "legendFormat": "Processed",
          "refId": "A"
        },
        {
          "expr": "rate(redis_retry_events_failed_total[2m])",
          "legendFormat": "Failed",
          "refId": "B"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 12,
        "x": 6,
        "y": 46
      }
    },
    {
      "title": "Redis Retry Job Duration (s)",
      "type": "timeseries",
      "id": 26,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "redis_retry_dispatch_execution_seconds_sum/redis_retry_dispatch_execution_seconds_count",
          "legendFormat": "Avg Duration",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 18,
        "y": 46
      }
    },
    {
      "title": "Redis Retry Queue Size",
      "type": "gauge",
      "id": 12,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "redis_retry_zset_size",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 12,
        "y": 26
      }
    },
    {
      "title": "Outbox Event Backlog",
      "type": "gauge",
      "id": 13,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "outbox_event_backlog",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 18,
        "y": 26
      }
    },
    {
      "title": "Outbox Dispatcher Batch Size",
      "type": "gauge",
      "id": 23,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "outbox_dispatch_batch_size",
          "legendFormat": "Outbox Batch Size",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 6,
        "x": 18,
        "y": 41
      }
    },
    {
      "title": "JVM Heap Memory Utilization (%)",
      "type": "gauge",
      "id": 14,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent"
        }
      },
      "targets": [
        {
          "expr": "sum(jvm_memory_used_bytes{area=\"heap\"})/sum(jvm_memory_max_bytes{area=\"heap\"})*100",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 5,
        "x": 0,
        "y": 31
      }
    },
    {
      "title": "CPU Usage (%)",
      "type": "gauge",
      "id": 15,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent"
        }
      },
      "targets": [
        {
          "expr": "process_cpu_usage{job=\"payment-service\"} * 100",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 5,
        "x": 5,
        "y": 31
      }
    },
    {
      "title": "GC Pause (max ms)",
      "type": "gauge",
      "id": 16,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ms"
        }
      },
      "targets": [
        {
          "expr": "max(jvm_gc_pause_seconds_max) * 1000",
          "legendFormat": "GC Pause (ms)",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 5,
        "x": 10,
        "y": 31
      }
    },
    {
      "title": "JVM Live Threads",
      "type": "gauge",
      "id": 17,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "jvm_threads_live_threads",
          "legendFormat": "Live Threads",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 5,
        "x": 15,
        "y": 31
      }
    },
    {
      "title": "HTTP 5xx Error Rate (/payments)",
      "type": "timeseries",
      "id": 18,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{status=~\"5..\", uri=\"/payments\"}[2m]))",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 12,
        "x": 0,
        "y": 36
      }
    },
    {
      "title": "HTTP 4xx Error Rate (/payments)",
      "type": "timeseries",
      "id": 19,
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{status=~\"4..\", uri=\"/payments\"}[2m]))",
          "refId": "A"
        }
      ],
      "gridPos": {
        "h": 5,
        "w": 12,
        "x": 12,
        "y": 36
      }
    }
  ]
}